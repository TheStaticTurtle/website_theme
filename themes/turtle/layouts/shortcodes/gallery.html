{{ $images := slice }}
{{ range split .Inner "\n" }}
    {{ if hasPrefix . "http" }}
        {{ $images = $images | append (replace . "\r" "") }}
    {{ end }}
    {{ if hasPrefix . "images" }}
        {{ $images = $images | append (replace . "\r" "") }}
    {{ end }}
{{ end }}

{{ $imageIndex := 0 }}

<div class="img-gallery-container">
    {{ range $images }}
        {{ $newRow :=  or (eq $imageIndex 0) (modBool $imageIndex 3) }}
        {{ $endRow :=  or (eq $imageIndex (sub (len  $images) 1)) (eq (mod $imageIndex 3) 2) }}

        {{ if $newRow  }}<div class="img-gallery-row">{{ end }}
            
            {{- $img := $.Page.Resources.GetMatch . -}}
            {{- if and (not $img) $.Page.File -}}
                {{ $path := path.Join $.Page.File.Dir . }}
                {{- $img = resources.Get $path -}}
            {{- end -}}
            
            {{ with $img }}
                {{ $image := . }}
                {{ if gt $img.Height 720 }}
                    {{ $image = .Resize "0x720 webp q80" }}
                {{ end }}
                <a class="img-gallery-image" target="_blank" href="{{ . }}">
                    <img src="{{ $image.RelPermalink }}" >
                </a>
            {{ else }}
                {{ warnf "[shortcodes/gallery.html] Couldn't resize: %s " .Destination }}
                <a class="img-gallery-image" target="_blank" href="{{ . }}">
                    <img src="{{ . }}" >
                </a>
            {{ end }}
                
        {{ if $endRow }}</div>{{ end }}

        {{ $imageIndex = add $imageIndex 1}}
    {{ end }}
</div>