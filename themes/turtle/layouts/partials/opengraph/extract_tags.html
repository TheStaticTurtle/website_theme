{{ warnf "[opengraph_embeds] Getting tags for: %s" $ }}

{{ $tags := dict }}
{{ $error := false }}

{{ $opts := dict
    "method" "get"
    "headers" (dict
        "User-Agent" "Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)" 
    )
}}
{{ with resources.GetRemote . $opts }}
    {{ with .Err }}
        {{ $error = . }}
        {{ warnf "[opengraph_embeds] %s" . }}
    {{ else }}
        {{ range findRE `<meta.*?(?:property|name)="(.+?)".*?content="(.*?)".*?\/?>` .Content }}
            {{/* Stupid workaround because hugo doesn't support capture groups in template (yet, https://github.com/gohugoio/hugo/issues/10594) */}}
            {{ $property := replaceRE `^.*?(?:property|name)="|".*$` "" .  }}
            {{ $content := replaceRE `^.*?content="|".*$` "" .  }}
            {{ if or (hasPrefix $property "og:") (hasPrefix $property "twitter:") }}
                {{ $tags = merge $tags (dict $property $content) }}
            {{ end }}
        {{ end }}
    {{ end }}
{{ end }}

{{ return (dict
    "link" .
    "tags" $tags
    "error" $error
    "valid" (and (eq $error false) (gt (len $tags) 0))
)}}