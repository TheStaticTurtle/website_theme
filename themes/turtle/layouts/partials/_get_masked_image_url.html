{{ $imageSrc := index . "src" }}
{{ $outputResolution := default "1275x712 webp q100" (index . "dim") }}

{{ $imageFilename := print ($imageSrc | md5) (path.Ext $imageSrc) }}
{{ $imgPath := path.Join $.Page.RelPermalink "images/" $imageFilename }}

{{ if hasPrefix $imageSrc "http" }}
    {{ warnf "[image_hook_remote] Downloading and masking %s" $imageSrc }}
    {{ with resources.GetRemote $imageSrc  }}
        {{ with .Err }}
            {{ warnf "[image_hook_remote] Couldn't download %s" $imageSrc }}
        {{ else }}
            {{ $img := (. | resources.Copy $imgPath).Fit $outputResolution  }}
            {{ $imageSrc = $img.Permalink }}
        {{ end }}
    {{ else }}
        {{ warnf "[image_hook_remote] Couldn't download %s" $imageSrc }}
    {{ end }}
{{ else }}
    {{ warnf "[image_hook_local] Resizing %s" $imageSrc }}
    {{ with (index $ "res").GetMatch $imageSrc }}
        {{ $img := .Fit $outputResolution  }}
        {{ $imageSrc = $img.Permalink }}
    {{ else }}
        {{ warnf "[image_hook_local] Couldn't get %s" $imageSrc }}
    {{ end }}
{{ end }}

{{ return $imageSrc }}